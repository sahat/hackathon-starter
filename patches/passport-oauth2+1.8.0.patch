diff --git a/node_modules/passport-oauth2/lib/strategy.js b/node_modules/passport-oauth2/lib/strategy.js
index 8575b72..76c798f 100644
--- a/node_modules/passport-oauth2/lib/strategy.js
+++ b/node_modules/passport-oauth2/lib/strategy.js
@@ -1,7 +1,5 @@
 // Load modules.
 var passport = require('passport-strategy')
-  , url = require('url')
-  , uid = require('uid2')
   , crypto = require('crypto')
   , base64url = require('base64url')
   , util = require('util')
@@ -100,7 +98,7 @@ function OAuth2Strategy(options, verify) {
   this._scope = options.scope;
   this._scopeSeparator = options.scopeSeparator || ' ';
   this._pkceMethod = (options.pkce === true) ? 'S256' : options.pkce;
-  this._key = options.sessionKey || ('oauth2:' + url.parse(options.authorizationURL).hostname);
+  this._key = options.sessionKey || ('oauth2:' + new URL(options.authorizationURL).hostname);
 
   if (options.store && typeof options.store == 'object') {
     this._stateStore = options.store;
@@ -141,11 +139,10 @@ OAuth2Strategy.prototype.authenticate = function(req, options) {
 
   var callbackURL = options.callbackURL || this._callbackURL;
   if (callbackURL) {
-    var parsed = url.parse(callbackURL);
-    if (!parsed.protocol) {
+    if (!/^[a-zA-Z][a-zA-Z0-9+\-.]*:/.test(callbackURL)) {
       // The callback URL is relative, resolve a fully qualified URL from the
       // URL of the originating request.
-      callbackURL = url.resolve(utils.originalURL(req, { proxy: this._trustProxy }), callbackURL);
+      callbackURL = new URL(callbackURL, utils.originalURL(req, { proxy: this._trustProxy })).href;
     }
   }
 
@@ -174,7 +171,9 @@ OAuth2Strategy.prototype.authenticate = function(req, options) {
 
       self._oauth2.getOAuthAccessToken(code, params,
         function(err, accessToken, refreshToken, params) {
-          if (err) { return self.error(self._createOAuthError('Failed to obtain access token', err)); }
+          if (err) {
+            return self.error(self._createOAuthError('Failed to obtain access token', err));
+          }
           if (!accessToken) { return self.error(new Error('Failed to obtain access token')); }
 
           self._loadUserProfile(accessToken, function(err, profile) {
@@ -266,22 +265,34 @@ OAuth2Strategy.prototype.authenticate = function(req, options) {
       //       state store.
       params.state = state;
       
-      var parsed = url.parse(this._oauth2._authorizeUrl, true);
-      utils.merge(parsed.query, params);
-      parsed.query['client_id'] = this._oauth2._clientId;
-      delete parsed.search;
-      var location = url.format(parsed);
+      var parsed = new URL(this._oauth2._authorizeUrl);
+      var query = {};
+      parsed.searchParams.forEach(function(value, key) {query[key] = value;});
+      utils.merge(query, params);
+      query['client_id'] = this._oauth2._clientId;
+      parsed.search = '';
+      Object.keys(query).forEach(function(key) {parsed.searchParams.set(key, query[key]);});
+      parsed.search = parsed.search.replace(/\+/g, '%20');
+      var location = parsed.href;
       this.redirect(location);
     } else {
       function stored(err, state) {
         if (err) { return self.error(err); }
 
         if (state) { params.state = state; }
-        var parsed = url.parse(self._oauth2._authorizeUrl, true);
-        utils.merge(parsed.query, params);
-        parsed.query['client_id'] = self._oauth2._clientId;
-        delete parsed.search;
-        var location = url.format(parsed);
+        var parsed = new URL(self._oauth2._authorizeUrl);
+        var query = {};
+        parsed.searchParams.forEach(function(value, key) {
+          query[key] = value;
+        });
+        utils.merge(query, params);
+        query['client_id'] = self._oauth2._clientId;
+        parsed.search = '';
+        Object.keys(query).forEach(function(key) {
+          parsed.searchParams.set(key, query[key]);
+        });
+        parsed.search = parsed.search.replace(/\+/g, '%20');
+        var location = parsed.href;
         self.redirect(location);
       }
 
