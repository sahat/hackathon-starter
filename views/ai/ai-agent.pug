extends ../layout

block content
  .container.mt-4
    .row
      .col-12
        h2 AI Agent: Customer Service Example
        .row.align-items-stretch
          .col-md-6
            .card.h-100
              .card-header
                h5.mb-0 Customer Service Chat
              .card-body.d-flex.flex-column
                #chat-messages.mb-3.flex-grow-1.overflow-auto.border.rounded.p-3
                  .text-muted.mb-3
                    p Welcome! I'm your AI customer service representative. I can help you with:
                    ul.small
                      li Order tracking and status
                      li Returns and refunds
                      li Replacements for damaged items
                      li Order cancellations
                      li Payment and billing issues
                    p.mt-2 Try asking about order #1234 or mention any customer service issue!
                .input-group.mt-2
                  input#message-input.form-control(type='text', placeholder='Type your message...')
                  button#send-button.btn.btn-primary(type='button')
                    span Send
                    span#send-spinner.spinner-border.spinner-border-sm.ms-2(role='status', aria-hidden='true', style='display: none')

          .col-md-6
            .card.h-100
              .card-header
                h6.mb-0 System Status
              .card-body
                p.mb-2
                  strong Status:
                  |
                  span#status Ready
                #status-messages.mb-3.overflow-auto.border.rounded.p-2.bg-light(style='max-height: 150px')
                  .text-muted.small No status messages yet
                h6.mb-2 Raw Stream Data
                #raw-data.mb-3.overflow-auto.border.rounded.p-2.bg-light.font-monospace.small(style='max-height: 200px')
                  .text-muted.small No raw data yet

    .row.mt-5
      .col-12
        .card.border-info
          .card-header.bg-info.text-white
            h5.mb-0
              i.fas.fa-code.me-2
              | ðŸ› ï¸ Developer Guide: AI Agent Boilerplate
          .card-body
            .row
              .col-md-6
                h6.text-primary
                  i.fas.fa-info-circle.me-1
                  | What is this?
                p This is #[strong LangChain v1 ReAct Agent] demo built with:
                ul.small
                  li #[code createAgent] from the #[code langchain] package
                  li #[strong Groq] as the LLM provider (fast inference with Llama 3.3 70B)
                  li #[strong Server-Sent Events (SSE)] for real-time streaming
                  li #[strong Middleware] for observability (the status updates you see)
                  li #[strong MemorySaver] for conversation persistence across messages

              .col-md-6
                h6.text-primary.mt-3
                  i.fas.fa-cogs.me-1
                  | How it works
                ol.small
                  li User sends a message via the chat input
                  li Backend creates/uses a persistent agent with tools
                  li Agent decides which tools to call based on the query
                  li #[strong Middleware] emits status updates at each stage (beforeModel, afterModel, wrapToolCall)
                  li #[strong Tools] emit progress via #[code config.writer] during execution
                  li Results stream back to the UI in real-time

              .col-12
                h6.text-success
                  | Quick Start for Your Hackathon
                .small
                  strong Step 1: Define Your Domain
                  p.mb-2 Replace the customer service scenario with your business problem. Edit the #[code systemPrompt] in #[code controllers/ai-agent.js]

                  strong Step 2: Create Your Tools
                  p.mb-2 Tools are how your agent interacts with the world. Look for #[code tool()] definitions and create your own:

                  strong Step 3: Add to Agent
                  p.mb-0 Add your tools to the #[code tools] array in #[code createCustomerServiceAgent()]

            mt-3.mb-0.small
              | #[strong Tip:] The #[code observabilityMiddleware] in #[code ai-agent.js] shows how to add custom status updates. Use #[code config.writer] inside your tools to emit real-time progress to users!

  script.
    let sessionId = '#{sessionId}';
    let abortController = null;
    const chat = document.getElementById('chat-messages');
    const status = document.getElementById('status');
    const statusMessages = document.getElementById('status-messages');
    const rawData = document.getElementById('raw-data');
    const input = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-button');
    const spinner = document.getElementById('send-spinner');
    const ts = () => `[${new Date().toLocaleTimeString()}]`;
    sendBtn.onclick = send;
    input.onkeydown = (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        send();
      }
    };

    async function send() {
      const text = input.value.trim();
      if (!text) return;
      append(chat, `${ts()} You: ${text}`);
      input.value = '';
      sendBtn.disabled = true;
      spinner.style.display = 'inline-block';
      status.textContent = 'Processing...';

      // Abort any previous request
      if (abortController) abortController.abort();
      abortController = new AbortController();

      try {
        const csrf = document.querySelector('meta[name="csrf-token"]').content;
        const response = await fetch('/ai/ai-agent/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': csrf,
          },
          body: JSON.stringify({ message: text, sessionId }),
          signal: abortController.signal,
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        // Read SSE stream from fetch response
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop(); // Keep incomplete line in buffer

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const data = JSON.parse(line.slice(6));
              if (data.type === 'chat') {
                append(chat, `${ts()} AI: ${data.message}`);
              } else if (data.type === 'status') {
                append(statusMessages, `${ts()} ${data.message}`);
              } else if (data.type === 'raw') {
                appendRaw(JSON.stringify(data.content, null, 2));
              } else if (data.type === 'done') {
                // Stream complete
              } else if (data.type === 'error') {
                append(chat, `${ts()} Error: ${data.error}`);
              }
            }
          }
        }
      } catch (err) {
        if (err.name !== 'AbortError') {
          append(chat, `${ts()} Error: ${err.message}`);
        }
      } finally {
        cleanup();
      }
    }

    function cleanup() {
      abortController = null;
      sendBtn.disabled = false;
      spinner.style.display = 'none';
      status.textContent = 'Ready';
    }

    function append(container, text) {
      const div = document.createElement('div');
      div.className = 'mb-2';
      div.textContent = text;
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }

    function appendRaw(text) {
      const pre = document.createElement('pre');
      pre.className = 'small border-bottom pb-2 mb-2';
      pre.textContent = text;
      rawData.appendChild(pre);
      rawData.scrollTop = rawData.scrollHeight;
    }
